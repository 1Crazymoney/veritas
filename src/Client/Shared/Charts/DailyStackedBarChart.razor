@using ChartJs.Blazor.Common
@using ChartJs.Blazor.Util
@using ChartJs.Blazor.BarChart
@using ChartJs.Blazor.Common.Enums
@using ChartJs.Blazor.BarChart.Axes
@using Domain.Common
@using ChartJs.Blazor;

<Chart Config="_config"/>

@code
{
    private BarConfig? _config;

    private static Dictionary<DateOnly, int> RandomData(int days) => Enumerable
        .Range(0, days)
        .Select(i => new
        {
            Key = DateOnly.FromDateTime(DateTime.UtcNow).AddDays(-i),
            Value = Random.Shared.Next(0, 100),
        })
        .Reverse()
        .ToDictionary(kv => kv.Key, kv => kv.Value);

    private Dictionary<Party, Dictionary<DateOnly, int>> _dailyVotes = new()
    {
        [new Party(42)] = RandomData(5),
        [new Party(5)] = RandomData(5),
        [new Party(9)] = RandomData(5),
        [new Party(36)] = RandomData(5),
    };

    protected override void OnInitialized()
    {
        _config = new BarConfig
        {
            Options = new BarOptions
            {
                Responsive = true,
                Legend = new Legend
                {
                    Display = false,
                },
                Animation = new ArcAnimation
                {
                    Easing = Easing.EaseInOutQuint,
                    Duration = 300,
                },
                Tooltips = new Tooltips
                {
                    Mode = InteractionMode.Index,
                    Intersect = true,
                    BackgroundColor = "#000000",
                    DisplayColors = true,
                    BodyFontFamily = "archyedt",
                    BodyFontSize = 18,
                    BodySpacing = 10,
                    XPadding = 10,
                    YPadding = 10,
                },
                Scales = new BarScales
                {
                    XAxes =
                    [
                        new BarCategoryAxis
                        {
                            Stacked = true,
                            GridLines = new GridLines
                            {
                                Color = ColorUtil.ColorString(50, 50, 50),
                                ZeroLineColor = ColorUtil.ColorString(50, 50, 50),
                            },
                        },
                    ],
                    YAxes =
                    [
                        new BarLinearCartesianAxis
                        {
                            Stacked = true,
                            GridLines = new GridLines
                            {
                                Color = ColorUtil.ColorString(50, 50, 50),
                                ZeroLineColor = ColorUtil.ColorString(50, 50, 50),
                            },
                        },
                    ],
                },
            },
        };

        foreach (var date in _dailyVotes.Values.First().Keys)
        {
            _config.Data.Labels.Add(date.ToDateTime().DaysAgoGe());
        }

        foreach (var (party, votes) in _dailyVotes)
        {
            var (r, g, b) = party.GetColorRgb();

            var dataset = new BarDataset<int>(votes.Values.ToArray())
            {
                Label = party.GetName(),
                BackgroundColor = ColorUtil.ColorHexString(r, g, b),
            };

            _config.Data.Datasets.Add(dataset);
        }
    }
}